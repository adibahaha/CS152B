/*
 * main.c
 *
 *  Created on: Nov 26, 2025
 *      Author: adiba
 */


#include <stdio.h>
#include "xil_printf.h"
#include "xparameters.h"
#include "xil_cache.h"
#include "PmodBT2.h"
#include "sleep.h"
#include "xgpio.h"
#include "xuartlite.h"

typedef XUartLite SysUart;

// UART macros
#define SysUart_Send            XUartLite_Send
#define SysUart_Recv            XUartLite_Recv
#define SYS_UART_DEVICE_ID      XPAR_AXI_UARTLITE_0_DEVICE_ID
#define BT2_UART_AXI_CLOCK_FREQ XPAR_CPU_M_AXI_DP_FREQ_HZ

PmodBT2 myDevice;
SysUart myUart;

void Initialize();
void Run();
void SysUartInit();
void EnableCaches();
void DisableCaches();

int main() {
   Initialize();
   Run();
   DisableCaches();
   return XST_SUCCESS;
}

void Initialize() {
   EnableCaches();
   SysUartInit();

   // Initialize PmodBT2
   BT2_Begin(
      &myDevice,
      XPAR_PMODBT2_0_AXI_LITE_GPIO_BASEADDR,
      XPAR_PMODBT2_0_AXI_LITE_UART_BASEADDR,
      BT2_UART_AXI_CLOCK_FREQ,
      115200
   );
}

void Run() {
    u8 buf[1];
    int n;

    print("PmodBT2 Test: Echo mode\r\n");
    print("Type in terminal: sends to BT2\r\n");
    print("Send from BT2 device: appears here\r\n\n");

    while (1) {

        // Receive from PC terminal → echo and forward to BT2
        n = SysUart_Recv(&myUart, buf, 1);
        if (n != 0) {
            SysUart_Send(&myUart, buf, 1);
            BT2_SendData(&myDevice, buf, 1);
        }

        // Receive from BT2 → forward to PC terminal
        n = BT2_RecvData(&myDevice, buf, 1);
        if (n != 0) {
            SysUart_Send(&myUart, buf, 1);
        }
    }
}

// Initialize system UART
void SysUartInit() {
#ifdef __MICROBLAZE__
   XUartLite_Initialize(&myUart, SYS_UART_DEVICE_ID);
#else
   XUartPs_Config *myUartCfgPtr;
   myUartCfgPtr = XUartPs_LookupConfig(SYS_UART_DEVICE_ID);
   XUartPs_CfgInitialize(&myUart, myUartCfgPtr, myUartCfgPtr->BaseAddress);
#endif
}

void EnableCaches() {
#ifdef __MICROBLAZE__
#ifdef XPAR_MICROBLAZE_USE_ICACHE
   Xil_ICacheEnable();
#endif
#ifdef XPAR_MICROBLAZE_USE_DCACHE
   Xil_DCacheEnable();
#endif
#endif
}

void DisableCaches() {
#ifdef __MICROBLAZE__
#ifdef XPAR_MICROBLAZE_USE_DCACHE
   Xil_DCacheDisable();
#endif
#ifdef XPAR_MICROBLAZE_USE_ICACHE
   Xil_ICacheDisable();
#endif
#endif
}
